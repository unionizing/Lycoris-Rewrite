-- ExploitTab module.
local ExploitTab = {}

---@module Features.Game.Teleport
local Teleport = require("Features/Game/Teleport")

---Initialize Mob Exploits section.
---@param groupbox table
function ExploitTab.initMobExploitsSection(groupbox)
	local voidMobsToggle = groupbox:AddToggle("VoidMobs", {
		Text = "Void Mobs",
		Tooltip = "Teleport nearby mobs and send them to the void.",
		Default = false,
	})

	voidMobsToggle:AddKeyPicker("VoidMobsKeyBind", { Default = "N/A", SyncToggleState = true, Text = "Void Mobs" })
end

---Initialize Local Character Exploits section.
---@param groupbox table
function ExploitTab.initLocalCharacterExploitsSection(groupbox)
	local moveWhileKnockedToggle = groupbox:AddToggle("MoveWhileKnocked", {
		Text = "Move While Knocked",
		Tooltip = "Move your character while in a knocked down state.",
		Default = false,
	})

	moveWhileKnockedToggle:AddKeyPicker(
		"MoveWhileKnockedKeyBind",
		{ Default = "N/A", SyncToggleState = true, Text = "Move While Knocked" }
	)

	local pathfindBreakerToggle = groupbox:AddToggle("PathfindBreaker", {
		Text = "Pathfind Breaker",
		Tooltip = "Visibly break the pathfinding for humanoid mobs by attempting to spoof your vertical velocity.",
		Default = false,
	})

	pathfindBreakerToggle:AddKeyPicker(
		"PathfindBreakerKeyBind",
		{ Default = "N/A", SyncToggleState = true, Text = "Pathfind Breaker" }
	)

	local pbDepBox = groupbox:AddDependencyBox()

	local pbHighlightToggle = pbDepBox:AddToggle("PathfindBreakerHighlight", {
		Text = "Show Highlight",
		Tooltip = "Because this feature can be very visible, you can enable a visual highlight to see if it is on.",
		Default = false,
	})

	pbHighlightToggle:AddColorPicker("PathfindBreakerHighlightColor", {
		Default = Color3.fromRGB(200, 0, 255),
		Text = "Highlight Color",
	})

	pbHighlightToggle:AddColorPicker("PathfindBreakerHighlightOutlineColor", {
		Default = Color3.fromRGB(255, 152, 234),
		Text = "Outline Color",
	})

	pbDepBox:SetupDependencies({
		{ pathfindBreakerToggle, true },
	})
end

---Add teleport button with disclaimer.
---@param groupbox table
---@param text string
---@param dest string
local function addTeleportButton(groupbox, text, dest)
	groupbox:AddButton({
		Text = text,
		Tooltip = "All teleports can bug out and cause death. They also may be very visible to other players.",
		DoubleClick = true,
		DoubleClickText = "Use at your own risk?",
		Func = function()
			Teleport.start(dest)
		end,
	})
end

---Initialize Teleports section.
---@param tabbox table
function ExploitTab.initTeleportsSection(tabbox)
	local teleportsTab = tabbox:AddTab("Teleports")
	local guildDoorTab = tabbox:AddTab("Guild Door")

	if game.PlaceId == 6032399813 then
		addTeleportButton(teleportsTab, "Teleport to Eastern Luminant", "EasternLuminant")
		addTeleportButton(teleportsTab, "Teleport to Trial Of One", "TrialOfOne")
	end

	if game.PlaceId == 6473861193 then
		addTeleportButton(teleportsTab, "Teleport to Etrean Luminant", "EtreanLuminant")
	end

	addTeleportButton(teleportsTab, "Teleport to Depths", "Depths")
	addTeleportButton(teleportsTab, "Teleport to Voidheart", "Voidheart")

	teleportsTab:AddButton("Stop Teleporting", Teleport.stop)

	guildDoorTab:AddInput("GuildDoorName", {
		Text = "Guild Door Name",
		Placeholder = "Exact or partial name of door.",
	})

	addTeleportButton(guildDoorTab, "Teleport To Guild Door", "GuildDoor")
end

---Initialize tab.
---@param window table
function ExploitTab.init(window)
	-- Create tab.
	local tab = window:AddTab("Exploit")

	-- Fetch realm information.
	local replicatedStorage = game:GetService("ReplicatedStorage")
	local info = replicatedStorage:WaitForChild("Info")
	local realmInfo = info:WaitForChild("RealmInfo")
	local realmInfoModule = require(realmInfo)
	local currentWorld = realmInfoModule.CurrentWorld or "N/A"

	-- Initialize sections.
	ExploitTab.initMobExploitsSection(tab:AddDynamicGroupbox("Mob Exploits"))
	ExploitTab.initLocalCharacterExploitsSection(tab:AddDynamicGroupbox("Local Character Exploits"))

	if currentWorld == "Depths" or currentWorld == "Mission" or currentWorld == "Dungeon" then
		return
	end

	ExploitTab.initTeleportsSection(tab:AddDynamicTabbox("Teleports"))
end

-- Return ExploitTab module.
return ExploitTab
